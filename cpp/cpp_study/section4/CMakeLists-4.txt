cmake_minimum_required(VERSION 3.14)  # 3.14 支持 protobuf_generate_cpp，也可用 3.28
project(section4_project)             # 项目名自定义

# 设置 common 和资源目录
set(COMMON_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../common")
set(RESOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}")

# 查找 Protobuf（需要 libprotobuf-dev 和 protobuf-compiler）
find_package(Protobuf REQUIRED)

# 尝试用 pkg-config 找 cpr（兼容性更好）
find_package(PkgConfig QUIET)
if(PKG_CONFIG_FOUND)
    pkg_check_modules(PC_CPR QUIET cpr)
endif()

# 如果 pkg-config 找不到，就假设 cpr 在系统路径（仅当真需要第三方 CPR 时才用）
if(PC_CPR_FOUND)
    add_library(cpr_lib INTERFACE IMPORTED)
    target_link_libraries(cpr_lib INTERFACE ${PC_CPR_LDFLAGS})
    target_include_directories(cpr_lib INTERFACE ${PC_CPR_INCLUDE_DIRS})
else()
    # 如果不需要第三方 CPR 库，可以忽略；或者报错提示
    # message(WARNING "cpr library not found via pkg-config. Assuming cpr.cpp is self-contained.")
endif()

# 查找 gperftools 的 libprofiler
find_library(PROFILER_LIBRARY
    NAMES profiler
    DOC "Path to libprofiler.so"
)
if(NOT PROFILER_LIBRARY)
    message(FATAL_ERROR "libprofiler not found. Please install libgoogle-perftools-dev (Ubuntu/Debian) or gperftools-devel (CentOS/RHEL)")
endif()

# 查找头文件
find_path(LUAJIT_INCLUDE_DIR luajit.h
    PATHS /usr/local/include/luajit-2.1 /usr/include/luajit-2.1
    NO_DEFAULT_PATH
)

# 查找库文件
find_library(LUAJIT_LIBRARY NAMES luajit-5.1 luajit
    PATHS /usr/local/lib /usr/lib
    NO_DEFAULT_PATH
)

if(NOT LUAJIT_INCLUDE_DIR)
    message(FATAL_ERROR "LuaJIT header (luajit.h) not found!")
endif()

if(NOT LUAJIT_LIBRARY)
    message(FATAL_ERROR "LuaJIT library (libluajit-5.1.so) not found!")
endif()

find_path(LUABRIDGE_INCLUDE_DIR LuaBridge/LuaBridge.h
    PATHS
        /workspace/dev/recipes/cpp/cpp_study/common/LuaBridge-2.6/Source
        /usr/local/include
        /opt/include
    NO_DEFAULT_PATH  # 可选：只在指定路径中找
)

if(NOT LUABRIDGE_INCLUDE_DIR)
    message(FATAL_ERROR "LuaBridge header (LuaBridge.h) not found!")
endif()

find_package(Python3 COMPONENTS Interpreter Development REQUIRED)
find_package(pybind11 CONFIG REQUIRED)

# 添加头文件-only 的 INTERFACE 库：common
add_library(common INTERFACE)

# 设置 common 接口包含路径
target_include_directories(common
    INTERFACE
        ${COMMON_DIR}
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${PROTOBUF_INCLUDE_DIRS}
        ${LUAJIT_INCLUDE_DIR}
        ${LUABRIDGE_INCLUDE_DIR}
        ${Python3_INCLUDE_DIRS}
)

# 设置 C++11 标准
target_compile_features(common INTERFACE cxx_std_11)

# ==================== Protobuf 代码生成 ====================

set(PROTO_FILES
    ${CMAKE_CURRENT_SOURCE_DIR}/sample.proto
    # ${CMAKE_CURRENT_SOURCE_DIR}/sample_v3.proto
)

set(EXISTING_PROTO_FILES)
foreach(proto_file IN LISTS PROTO_FILES)
    if(EXISTS ${proto_file})
        list(APPEND EXISTING_PROTO_FILES ${proto_file})
    endif()
endforeach()

if(EXISTING_PROTO_FILES)
    protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS ${EXISTING_PROTO_FILES})
else()
    message(WARNING "No .proto files found. Skipping protobuf code generation.")
    set(PROTO_SRCS)
    set(PROTO_HDRS)
endif()

set(SOURCES
    curl.cpp
    gperf.cpp
    json.cpp
    lua_shared.cpp
    luajit.cpp
    msgpack.cpp
    protobuf.cpp
    pybind.cpp
    zmq.cpp
    cpr.cpp
)

list(APPEND SOURCES ${PROTO_SRCS})

# ==================== 可执行文件 ====================

add_executable(cpr_test cpr.cpp)
# 注意：这里不要链接 "cpr"（目标名），也不要链接 cpr_lib 除非你真的用了第三方 CPR
# 假设 cpr.cpp 是独立程序，只依赖 common 和 curl/pthread
target_link_libraries(cpr_test common cpr curl pthread)

add_executable(curl_test curl.cpp)
target_link_libraries(curl_test common curl)

add_executable(gperf gperf.cpp)
target_link_libraries(gperf common ${PROFILER_LIBRARY})

add_executable(json json.cpp)
target_link_libraries(json common)

add_executable(luajit luajit.cpp)
target_link_libraries(luajit common ${LUAJIT_LIBRARY})

add_executable(msgpack msgpack.cpp)
target_link_libraries(msgpack common)

add_executable(protobuf protobuf.cpp)
target_link_libraries(protobuf common protobuf::libprotobuf)

pybind11_add_module(pydemo pybind.cpp)

add_executable(zmq_test zmq.cpp)
target_link_libraries(zmq_test common zmq pthread)

# ====== 共享库：lua_shared ======
add_library(lua_shared SHARED lua_shared.cpp)
target_link_libraries(lua_shared common)
if(Lua_FOUND)
    target_link_libraries(lua_shared ${LUA_LIBRARIES})
    target_include_directories(lua_shared PRIVATE ${LUA_INCLUDE_DIR})
endif()
set_target_properties(lua_shared PROPERTIES
    CXX_STANDARD 14
    CXX_STANDARD_REQUIRED ON
    OUTPUT_NAME "lua_shared"
)

# ==================== 静态库（不包含 cpr.cpp）====================

add_library(section4 STATIC ${SOURCES})
target_link_libraries(section4
    common
    protobuf::libprotobuf
)

# ==================== 安装规则 ====================

install(TARGETS
    cpr_test curl_test gperf json luajit msgpack protobuf zmq_test
    RUNTIME DESTINATION bin
)

install(TARGETS section4
    lua_shared
    ARCHIVE DESTINATION lib
    LIBRARY DESTINATION lib
    RUNTIME DESTINATION bin
)

install(FILES
    ${COMMON_DIR}/json.hpp
    ${PROTO_HDRS}
    DESTINATION include/common
)

set(RESOURCES
    demo.py
    embedded.lua
    flame.svg
    icicle.svg
    sample.proto
    sample_v3.proto
    setup.sh
    shared.lua
)

install(FILES
    ${RESOURCES}
    DESTINATION share/${PROJECT_NAME}
)

# ==================== 输出提示 ====================

message(STATUS "Project: ${PROJECT_NAME}")
message(STATUS "Protobuf include: ${PROTOBUF_INCLUDE_DIRS}")
message(STATUS "Protobuf libs: ${PROTOBUF_LIBRARIES}")
message(STATUS "Using libprofiler: ${PROFILER_LIBRARY}")