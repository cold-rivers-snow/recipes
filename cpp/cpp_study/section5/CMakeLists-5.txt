cmake_minimum_required(VERSION 3.14)  # 3.14 支持 protobuf_generate_cpp，也可用 3.28
project(section5_project)             # 项目名自定义

# 设置 common 和资源目录
set(COMMON_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../common")
set(RESOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}")

# 查找头文件
find_path(LUAJIT_INCLUDE_DIR luajit.h
    PATHS /usr/local/include/luajit-2.1 /usr/include/luajit-2.1
    NO_DEFAULT_PATH
)

# 查找库文件
find_library(LUAJIT_LIBRARY NAMES luajit-5.1 luajit
    PATHS /usr/local/lib /usr/lib
    NO_DEFAULT_PATH
)
# 尝试用 pkg-config 找 cpr（兼容性更好）
find_package(PkgConfig QUIET)
if(PKG_CONFIG_FOUND)
    pkg_check_modules(PC_CPR QUIET cpr)
endif()

# 如果 pkg-config 找不到，就假设 cpr 在系统路径（仅当真需要第三方 CPR 时才用）
if(PC_CPR_FOUND)
    add_library(cpr_lib INTERFACE IMPORTED)
    target_link_libraries(cpr_lib INTERFACE ${PC_CPR_LDFLAGS})
    target_include_directories(cpr_lib INTERFACE ${PC_CPR_INCLUDE_DIRS})
else()
    # 如果不需要第三方 CPR 库，可以忽略；或者报错提示
    # message(WARNING "cpr library not found via pkg-config. Assuming cpr.cpp is self-contained.")
endif()

if(NOT LUAJIT_INCLUDE_DIR)
    message(FATAL_ERROR "LuaJIT header (luajit.h) not found!")
endif()

if(NOT LUAJIT_LIBRARY)
    message(FATAL_ERROR "LuaJIT library (libluajit-5.1.so) not found!")
endif()

find_path(LUABRIDGE_INCLUDE_DIR LuaBridge/LuaBridge.h
    PATHS
        /workspace/dev/recipes/cpp/cpp_study/common/LuaBridge-2.6/Source
        /usr/local/include
        /opt/include
    NO_DEFAULT_PATH  # 可选：只在指定路径中找
)

if(NOT LUABRIDGE_INCLUDE_DIR)
    message(FATAL_ERROR "LuaBridge header (LuaBridge.h) not found!")
endif()

# 添加头文件-only 的 INTERFACE 库：common
add_library(common INTERFACE)

# 设置 common 接口包含路径
target_include_directories(common
    INTERFACE
        ${COMMON_DIR}
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${LUAJIT_INCLUDE_DIR}
        ${LUABRIDGE_INCLUDE_DIR}
)

# 设置 C++11 标准
target_compile_features(common INTERFACE cxx_std_11)

set(SOURCES
    client.cpp 
    srv.cpp
)

add_executable(client client.cpp)
target_link_libraries(client common ${LUAJIT_LIBRARY} cpr curl zmq pthread)
add_executable(srv srv.cpp)
target_link_libraries(srv common ${LUAJIT_LIBRARY} cpr curl zmq pthread)

install(TARGETS
    client srv
    RUNTIME DESTINATION bin
)

install(FILES
    ${COMMON_DIR}/json.hpp
    ${PROTO_HDRS}
    DESTINATION include/common
)
